@page "/mapping"
@inject ICompanyMappingService MappingService
@inject AppDbContext Db
@using Microsoft.EntityFrameworkCore

<h3>Company Mapping</h3>

@if (!string.IsNullOrWhiteSpace(message))
{
    <div class="info">@message</div>
}

@if (items.Count == 0)
{
    <p>No unmapped companies.</p>
}
else
{
    <table>
        <thead>
            <tr>
                <th>DisplayName</th>
                <th>AliasKey</th>
                <th>Top 5 Suggestions</th>
                <th>Map To</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in items)
            {
                <tr>
                    <td>@item.DisplayName</td>
                    <td><code>@item.AliasKey</code></td>
                    <td>@string.Join(", ", item.Candidates)</td>
                    <td>
                        <select value="@GetSelected(item.AliasKey)" @onchange="e => selected[item.AliasKey] = e.Value?.ToString() ?? string.Empty">
                            <option value="">-- select company --</option>
                            @foreach (var c in companies)
                            {
                                <option value="@c.Id.ToString()">@c.Key</option>
                            }
                        </select>
                        <button class="btn" @onclick="() => ApplyAsync(item.AliasKey)">Apply</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<MappingSuggestion> items = [];
    private List<Company> companies = [];
    private Dictionary<string, string> selected = [];
    private string? message;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        items = (await MappingService.GetUnmappedAsync()).ToList();
        companies = await Db.Companies
            .Where(x => !x.IsUnmapped)
            .OrderBy(x => x.Key)
            .ToListAsync();
    }

    private async Task ApplyAsync(string aliasKey)
    {
        if (!selected.TryGetValue(aliasKey, out var raw) || !int.TryParse(raw, out var targetId))
        {
            message = "Please select a target company first.";
            return;
        }

        await MappingService.ApplyMappingAsync(aliasKey, targetId);
        message = $"Mapped '{aliasKey}' successfully.";
        await ReloadAsync();
    }

    private string GetSelected(string aliasKey)
    {
        return selected.TryGetValue(aliasKey, out var value) ? value : string.Empty;
    }
}
